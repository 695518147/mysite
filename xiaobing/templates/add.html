<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>智能机器人</title>
    {% load bootstrap3 %}
    {% bootstrap_css %}
    <script type="text/javascript" charset="utf-8" src="/static/jquery-1.9.1.min.js"></script>
    {% bootstrap_javascript %}
    {% bootstrap_messages %}

    <script type="text/javascript" charset="utf-8" src="/static/ueditor/ueditor.config.js"></script>
    <script type="text/javascript" charset="utf-8" src="/static/ueditor/ueditor.all.min.js"></script>
    <!--建议手动加在语言，避免在ie下有时因为加载语言失败导致编辑器加载失败-->
    <!--这里加载的语言文件会覆盖你在配置项目里添加的语言类型，比如你在配置项目里配置的是英文，这里加载的中文，那最后就是中文-->
    <script type="text/javascript" charset="utf-8" src="/static/ueditor/lang/zh-cn/zh-cn.js"></script>

    <style type="text/css">
        div {
            width: 100%;
        }

        .modal-backdrop {
            position: fixed;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
            z-index: 1004;
            background-color: #000;
        }

        input[type=checkbox], input[type=radio] {
            margin: 10px 0 0;
        }

    </style>


</head>
<body class="container-fluid" style="overflow-x: hidden">

{#    createTime = models.DateTimeField()#}
<div class="panel panel-primary">
    <div class="panel-heading">新增指令</div>
    <div class="panel-body">
        <div id="orderForm" class="form-horizontal">
            {% csrf_token %}
            <div class="form-group">
                <label for="typeId" class="col-sm-2 control-label">指令类别</label>
                <div class="col-sm-10">
                    <select class="form-control" id="typeId">
                    </select><!-- 按钮触发模态框 -->
                    <button class="btn btn-primary" data-toggle="modal" onclick="modalHandler()">
                        新增类别
                    </button>
                </div>
            </div>
            <div class="form-group">
                <label for="orderName" class="col-sm-2 control-label">指令名称</label>
                <div class="col-sm-10" style="height: 20%">
                    <textarea id="orderName" placeholder="指令名称"></textarea>
                </div>
            </div>
            <div class="form-group">
                <label for="orderDescription" class="col-sm-2 control-label">是否显示词条指令</label>
                <div class="col-sm-10">
                    <input type="checkbox" id="isShowOrder" name="isShowOrder" checked/>
                </div>
            </div>
            <div class="form-group">
                <label for="orderDescription" class="col-sm-2 control-label">指令说明</label>
                <div class="col-sm-10">
                    <textarea id="orderDescription" placeholder="指令说明"></textarea>
                </div>
            </div>
            <div class="form-group">
                <label for="orderDescription" class="col-sm-2 control-label">是否显示指令说明</label>
                <div class="col-sm-10">
                    <input type="checkbox" id="isShow" name="isShow" checked/>
                </div>
            </div>
            <div class="form-group">
                <label for="typeDescription" class="col-sm-2 control-label">类别说明</label>
                <div class="col-sm-10">
                    <textarea id="typeDescription" placeholder="类别说明"></textarea>
                </div>
            </div>
            <div class="form-group">
                <label for="number" class="col-sm-2 control-label">排序号</label>
                <div class="col-sm-10">
                    <input type="text" class="form-control" id="number" placeholder="排序号" value="99">
                </div>
            </div>
            <div class="form-group">
                <div class="col-sm-offset-11 col-sm-10">
                    <input class="btn btn-default" type="button" id="button" onclick="saveOrder()" value="保存">
                </div>
            </div>
        </div>
    </div>
</div>


<!-- 模态框（Modal） -->
<div class="modal fade bs-example-modal-lg" id="myModal" tabindex="-9" style="z-index: 1005" role="dialog"
     aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="myModalLabel">
                    新增指令类别
                </h4>
            </div>
            <div class="modal-body">
                <div id="orderForm" class="form-horizontal">
                    <div class="form-group">
                        <label for="typeName" class="col-sm-2 control-label">指令名称</label>
                        <div class="col-sm-10">
                            <textarea id="typeName" placeholder="指令类别名称"></textarea>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="typeNumber" class="col-sm-2 control-label">排序号</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control" id="typeNumber" placeholder="排序号" value="99">
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭
                </button>
                <button type="button" id="saveOrderType" onclick="saveOrderType()" class="btn btn-primary">
                    保存
                </button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal -->
</div>

<div class="panel panel-primary">
    <div class="panel-heading">指令列表</div>
    <div class="panel-body">
        <table class="table table-bordered">
            <thead>
            <tr>
                <th>类别</th>
                <th>指令代码</th>
                <th>指令名称</th>
                <th>指令说明</th>
                <th>类型说明</th>
            </tr>
            </thead>

            {% autoescape off %}
                {% for order in orders %}
                    <tr>
                        <td>{{ order.typeId }}</td>
                        <td>{{ order.orderId }}</td>
                        <td>{{ order.orderName }}</td>
                        <td>{{ order.orderDescription }}</td>
                        <td>{{ order.typeDescription }}</td>
                    </tr>
                {% endfor %}
            {% endautoescape %}
        </table>

    </div>
</div>

<script type="text/javascript">

    function modalHandler() {
        $("#myModal").modal({backdrop: 'static', keyboard: false});
    }

    $(function () {
        init();
    });

    function init() {
        instanceUE('orderName');
        instanceUE('orderDescription');
        instanceUE('typeDescription');
        instanceUE('typeName');

        $.get("/xiaobing/getAllOrderType/").done(function (data) {
            var json = JSON.parse(data);
            var arr = [];
            $.each(json, function (index, order) {
                console.log(order.fields)
                var option = '<option value="' + order.fields.typeId + '">' + order.fields.typeName + '</option>';
                arr.push(option)
            });
            $("#typeId").empty().append(arr.join())

        });
    }

    function instanceUE(id) {
        UE.getEditor(id, {
            'toolbars': [['source', '|', 'undo', 'redo', '|', 'bold', 'italic', 'underline', 'formatmatch', 'autotypeset', '|', 'forecolor', 'backcolor', '|', 'link', 'unlink', '|', 'simpleupload', 'insertvideo', 'music', 'attachment', 'map']],
            'a': 2,
            'serverUrl': '/ueditor/controller/?imagePathFormat=image%2Forder&filePathFormat=bb%2F'
        }).ready(function () {

        });
    }

    function getUEBasePath(docUrl, confUrl) {

        return getBasePath(docUrl || self.document.URL || self.location.href, confUrl || getConfigFilePath());

    }

    function getConfigFilePath() {

        var configPath = document.getElementsByTagName('script');

        return configPath[configPath.length - 1].src;

    }

    function getBasePath(docUrl, confUrl) {

        var basePath = confUrl;


        if (/^(\/|\\\\)/.test(confUrl)) {

            basePath = /^.+?\w(\/|\\\\)/.exec(docUrl)[0] + confUrl.replace(/^(\/|\\\\)/, '');

        } else if (!/^[a-z]+:/i.test(confUrl)) {

            docUrl = docUrl.split("#")[0].split("?")[0].replace(/[^\\\/]+$/, '');

            basePath = docUrl + "" + confUrl;

        }

        return optimizationPath(basePath);

    }

    function optimizationPath(path) {

        var protocol = /^[a-z]+:\/\//.exec(path)[0],
            tmp = null,
            res = [];

        path = path.replace(protocol, "").split("?")[0].split("#")[0];

        path = path.replace(/\\/g, '/').split(/\//);

        path[path.length - 1] = "";

        while (path.length) {

            if ((tmp = path.shift()) === "..") {
                res.pop();
            } else if (tmp !== ".") {
                res.push(tmp);
            }

        }

        return protocol + res.join("/");

    }

    function saveOrder() {
        debugger;
        document.cookie = "csrfmiddlewaretoken=" + $("input[name=csrfmiddlewaretoken]").val();
        var typeId = document.getElementById("typeId").value;
        var isShow = $("#isShow").prop("checked");
        var isShowOrder = $("#isShowOrder").prop("checked");
        var orderName = getContent('orderName');
        var orderNameText = getContentText('orderName');
        var number = document.getElementById("number").value;
        var orderDescription = getContent('orderDescription');
        var typeDescription = getContent('typeDescription');

        var order = {
            typeId: typeId,
            isShow: isShow,
            isShowOrder: isShowOrder,
            orderName: orderName,
            orderNameText: orderNameText,
            number: number,
            orderDescription: orderDescription,
            typeDescription: typeDescription
        };


        $.ajax({
            type: "POST",
            url: "/xiaobing/saveOrder/",
            // 允许携带证书
            xhrFields: {
                withCredentials: true
            },
            // 允许跨域
            crossDomain: true,
            data: order
        }).done(function (data) {
            window.location.reload();
        });
    }

    function saveOrderType() {
        document.cookie = "csrfmiddlewaretoken=" + $("input[name=csrfmiddlewaretoken]").val();
        var typeName = getContent("typeName");
        var typeNameText = getContentText("typeName");
        var number = document.getElementById("typeNumber").value;

        var orderType = {
            typeName: typeName,
            typeNameText: typeNameText,
            number: number
        };

        $.ajax({
            type: "POST",
            url: "/xiaobing/saveType/",
            // 允许携带证书
            xhrFields: {
                withCredentials: true
            },
            // 允许跨域
            crossDomain: true,
            data: orderType
        }).done(function (data) {
            var json = JSON.parse(data);
            var arr = [];
            $.each(json, function (index, order) {
                console.log(order.fields)
                var option = '<option value="' + order.fields.typeId + '">' + order.fields.typeName + '</option>';
                arr.push(option)
            });
            $("#typeId").empty().append(arr.join())
            $("#myModal").modal('hide')
        }, 'json');
    }

    function getContent(id) {
        return UE.getEditor(id).getContent();
    }

    function getContentText(id) {
        return UE.getEditor(id).getContentTxt();
    }


</script>

</body>
</html>